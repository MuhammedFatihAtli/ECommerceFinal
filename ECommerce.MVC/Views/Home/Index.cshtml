@{
    ViewData["Title"] = "Home";
    bool filtreAktif = (ViewBag.SelectedCategoryId != null)
                       || !string.IsNullOrEmpty(ViewBag.Search as string)
                       || ViewBag.MinPrice != null
                       || ViewBag.MaxPrice != null
                       || (ViewBag.InStock != null && ViewBag.InStock == true);
}

<div class="accordion mb-5 shadow-sm rounded-3 border-0 overflow-hidden" id="filtreAccordion">
    <div class="accordion-item border-0">
        <h2 class="accordion-header" id="filtreHeading">
            <button class="accordion-button fw-semibold fs-6 py-3 px-4 bg-light @(filtreAktif ? "" : "collapsed")" type="button" data-bs-toggle="collapse" data-bs-target="#filtreCollapse" aria-expanded="@(filtreAktif.ToString().ToLower())" aria-controls="filtreCollapse">
                🔍 Filtreleme Seçenekleri
            </button>
        </h2>
        <div id="filtreCollapse" class="accordion-collapse collapse @(filtreAktif ? "show" : "")" aria-labelledby="filtreHeading" data-bs-parent="#filtreAccordion">
            <div class="accordion-body bg-white p-4">
                <form method="get" asp-action="Index" asp-controller="Home" class="row g-3 align-items-center justify-content-center">
                    <div class="col-auto">
                        <label for="categoryId" class="form-label mb-0">Kategori:</label>
                        <select id="categoryId" name="categoryId" class="form-select form-select-sm">
                            @if (ViewBag.SelectedCategoryId == null)
                            {
                                <option value="" selected>Tüm Kategoriler</option>
                            }
                            else
                            {
                                <option value="">Tüm Kategoriler</option>
                            }
                            @foreach (var category in ViewBag.Categories)
                            {
                                if (ViewBag.SelectedCategoryId != null && (int)ViewBag.SelectedCategoryId == category.Id)
                                {
                                    <option value="@category.Id" selected>@category.Name</option>
                                }
                                else
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-auto">
                        <label for="search" class="form-label mb-0">Ürün Adı:</label>
                        <input type="text" id="search" name="search" class="form-control form-control-sm" placeholder="Ara..." value="@(ViewBag.Search ?? "")" />
                    </div>
                    <div class="col-auto">
                        <label class="form-label mb-0">Fiyat:</label>
                        <div class="d-flex align-items-center">
                            <input type="number" step="0.01" min="0" name="minPrice" class="form-control form-control-sm me-1" placeholder="Min" value="@(ViewBag.MinPrice ?? "")" style="width: 80px;" />
                            <span class="mx-1">-</span>
                            <input type="number" step="0.01" min="0" name="maxPrice" class="form-control form-control-sm" placeholder="Max" value="@(ViewBag.MaxPrice ?? "")" style="width: 80px;" />
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="inStock" name="inStock" value="true" @(ViewBag.InStock != null && ViewBag.InStock == true ? "checked" : "") />
                            <label class="form-check-label small" for="inStock">Stokta olanlar</label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-sm btn-outline-primary rounded-pill px-3">Filtrele</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="container mt-5">
    <h3 class="mb-4 text-center fw-bold fs-1">Ürünler</h3>
    <div class="row">
        @if (ViewBag.Products != null && ((IEnumerable<dynamic>)ViewBag.Products).Any())
        {
            foreach (var product in ViewBag.Products)
            {
                <div class="col-md-4">
                    <div class="card mb-4 shadow rounded-4 border-0">
                        <div class="d-flex align-items-center justify-content-center" style="height:220px; background:#f5f6fa;">
                            @if (!string.IsNullOrEmpty(product.ImagePath))
                            {
                                <img src="@product.ImagePath" alt="@product.Name" class="img-fluid" style="max-height:200px; object-fit:contain; border-radius:16px;" />
                            }
                            else
                            {
                                <span class="text-muted">Resim yok</span>
                            }
                        </div>
                        <div class="card-body text-center">
                            <h6 class="card-title fw-semibold">@product.Name</h6>
                            <p class="card-text small text-muted">
                                @{
                                    var desc = product.Description ?? "";
                                    var shortDesc = desc.Length > 60 ? desc.Substring(0, 60) + "..." : desc;
                                }
                                @shortDesc
                            </p>

                            <p class="mb-1 text-muted small">
                                Kategori: @(string.IsNullOrEmpty(product.CategoryName) ? "Kategori Bulunamadı" : product.CategoryName)
                            </p>

                            <p class="mb-1"><strong class="text-success">@product.Price.ToString("C")</strong></p>
                            <div class="d-flex justify-content-center gap-2">
                                <form asp-controller="Cart" asp-action="Add" method="post">
                                    <input type="hidden" name="id" value="@product.Id" />
                                    <button type="submit" class="btn btn-success btn-sm rounded-pill">Sepete Ekle</button>
                                </form>
                                <form asp-controller="Product" asp-action="AddToFavorites" method="post">
                                    <input type="hidden" name="productId" value="@product.Id" />
                                    <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill">Favori</button>
                                </form>
                            </div>
                            <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="btn btn-primary btn-sm w-100 mt-2 rounded-pill">Detay</a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12 text-center text-muted">Ürün bulunamadı.</div>
        }
    </div>
</div>
